import{E as A,c as d,o as c,d as n,t as U,n as D,e as J,b as B,j as $,Z,G as F,m as X,v as ee,M as oe,q as z,V as ie,h as le,T as ce,B as ue,Q as E,k as de,P as _,y as fe,l as C,F as q,g as Q,s as G,f as ge}from"./index-BuJvUBZ3.js";const he={class:"whitespace-pre-wrap text-[15px]"},me={key:0,class:"ml-1"},ve={key:0,class:"fas fa-check-double"},ye={key:1,class:"fas fa-check"},pe={__name:"ChatMessage",props:{content:{type:String,required:!0},isCurrentUser:{type:Boolean,default:!1},isRead:{type:Boolean,default:!1},createdAt:{type:[String,Date],required:!0}},setup(l){const t=l,y=A(()=>{const m=new Date(t.createdAt);if(isNaN(m.getTime()))return"";const v=new Date,x=v-m,S=Math.floor(x/(1e3*60*60)),f=Math.floor(x/(1e3*60*60*24)),M=m.getHours().toString().padStart(2,"0"),I=m.getMinutes().toString().padStart(2,"0"),w=`${M}:${I}`;if(S<24&&m.getDate()===v.getDate())return w;if(f<7)return`${["CN","T2","T3","T4","T5","T6","T7"][m.getDay()]} ${w}`;if(m.getFullYear()===v.getFullYear()){const b=m.getDate().toString().padStart(2,"0"),H=(m.getMonth()+1).toString().padStart(2,"0");return`${b}/${H} ${w}`}const r=m.getDate().toString().padStart(2,"0"),u=(m.getMonth()+1).toString().padStart(2,"0"),p=m.getFullYear();return`${r}/${u}/${p} ${w}`});return(m,v)=>(c(),d("div",{class:D(["flex",l.isCurrentUser?"justify-end":"justify-start","mb-3"])},[n("div",{class:D(["max-w-[70%] rounded-2xl px-4 py-2.5 break-words shadow-sm",l.isCurrentUser?"bg-blue-500 text-white rounded-br-none":"bg-gray-100 text-gray-800 rounded-bl-none"])},[n("p",he,U(l.content),1),n("div",{class:D(["text-xs mt-1 flex justify-end items-center",l.isCurrentUser?"text-blue-100":"text-gray-500"])},[J(U(y.value)+" ",1),l.isCurrentUser?(c(),d("span",me,[l.isRead?(c(),d("i",ve)):(c(),d("i",ye))])):B("",!0)],2)],2)],2))}},xe={class:"flex-shrink-0 mr-3 relative"},be={key:0,class:"w-12 h-12 rounded-md overflow-hidden shadow-sm"},we=["src"],Ce={key:1,class:"w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-md flex items-center justify-center text-white font-bold shadow-sm"},Me={key:2,class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"},ke={class:"flex-1 min-w-0"},Se={class:"flex justify-between items-center"},Ie={class:"flex items-center mt-1"},Te={key:0,class:"ml-2 bg-blue-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center shadow-sm"},$e={__name:"ChatConversation",props:{displayName:{type:String,required:!0},avatar:{type:String,default:null},lastMessage:{type:String,default:""},lastMessageTime:{type:String,default:""},unreadCount:{type:Number,default:0},isOnline:{type:Boolean,default:!1},isActive:{type:Boolean,default:!1},isRead:{type:Boolean,default:!0},userId:{type:[Number,String],required:!0},openInPopup:{type:Boolean,default:!1}},emits:["select"],setup(l,{emit:t}){const y=l,m=t,v=$(!1),x=Z("openChat",null),S=r=>{if(!r)return!1;try{if(r.startsWith("src/assets/")||r.startsWith("/src/assets/"))return console.error("Đường dẫn avatar assets không tồn tại:",r),!1;const u=new URL(r);return r.match(/\.(jpeg|jpg|gif|png|webp)$/i)||r.includes("cloudinary.com")||r.includes("res.cloudinary.com"),!0}catch(u){return console.error("URL avatar không hợp lệ:",r,u),!1}},f=r=>{console.warn("Lỗi khi tải avatar:",y.avatar),v.value=!0,r.target.src="";try{const u=r.target.closest(".rounded-md");if(u){r.target.style.display="none";const p=document.createElement("div");p.className="w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 flex items-center justify-center text-white font-bold",p.textContent=I(y.displayName),u.appendChild(p),console.log(`Đã thay thế avatar lỗi cho ${y.displayName} với initials: ${I(y.displayName)}`)}}catch(u){console.error("Lỗi khi xử lý DOM sau lỗi avatar:",u)}},M=A(()=>{if(!y.lastMessageTime)return"";const r=new Date(y.lastMessageTime),u=new Date,p=u-r,b=Math.floor(p/(1e3*60)),H=Math.floor(p/(1e3*60*60)),V=Math.floor(p/(1e3*60*60*24));if(b<1)return"Vừa xong";if(b<60)return`${b} phút`;if(H<24&&r.getDate()===u.getDate()){const N=r.getHours().toString().padStart(2,"0"),L=r.getMinutes().toString().padStart(2,"0");return`${N}:${L}`}else{if(V<7)return["CN","T2","T3","T4","T5","T6","T7"][r.getDay()];if(r.getFullYear()===u.getFullYear()){const N=r.getDate().toString().padStart(2,"0"),L=(r.getMonth()+1).toString().padStart(2,"0");return`${N}/${L}`}else{const N=r.getDate().toString().padStart(2,"0"),L=(r.getMonth()+1).toString().padStart(2,"0"),T=r.getFullYear().toString().slice(2);return`${N}/${L}/${T}`}}}),I=r=>r?r.trim().charAt(0).toUpperCase():"?",w=()=>{y.openInPopup&&x?x(y.userId):m("select")};return(r,u)=>(c(),d("div",{class:D(["flex items-center px-4 py-3 cursor-pointer transition-colors border-b border-gray-100",{"bg-blue-50":l.isActive,"hover:bg-gray-50":!l.isActive,"border-l-4 border-l-blue-500":l.isActive}]),onClick:w},[n("div",xe,[l.avatar&&S(l.avatar)?(c(),d("div",be,[n("img",{src:l.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:f},null,40,we)])):(c(),d("div",Ce,U(I(l.displayName)),1)),l.isOnline?(c(),d("div",Me)):B("",!0)]),n("div",ke,[n("div",Se,[n("h3",{class:D(["text-sm font-medium truncate",[l.unreadCount>0?"text-gray-900 font-semibold":"text-gray-700"]])},U(l.displayName||`Người dùng #${l.userId}`),3),n("span",{class:D(["text-xs text-gray-500",[l.unreadCount>0?"text-blue-600 font-semibold":"text-gray-500"]])},U(M.value),3)]),n("div",Ie,[n("p",{class:D(["text-sm truncate flex-1",{"text-gray-700 font-medium":!l.isRead&&l.unreadCount>0,"text-gray-500":l.isRead||l.unreadCount===0}])},U(l.lastMessage),3),l.unreadCount>0?(c(),d("span",Te,U(l.unreadCount>99?"99+":l.unreadCount),1)):B("",!0)])])],2))}},Ne={class:"border-t border-gray-100 py-3 px-4 bg-white"},_e={class:"relative flex-1"},Ue=["onKeydown"],De=["disabled"],Le={__name:"ChatInput",props:{loading:{type:Boolean,default:!1}},emits:["send-message"],setup(l,{emit:t}){const y=l,m=t,v=$(""),x=$(null),S=$(1);$(!1);const f=A(()=>v.value.trim().length>0&&!y.loading),M=()=>{f.value&&(m("send-message",v.value.trim()),v.value="",S.value=1,setTimeout(()=>{x.value.focus()},10))},I=r=>{r.shiftKey||M()},w=()=>{const r=v.value.split(`
`);S.value=Math.min(r.length,5)};return F(v,()=>{w()}),(r,u)=>(c(),d("div",Ne,[n("form",{onSubmit:z(M,["prevent"]),class:"flex items-end gap-2"},[n("div",_e,[X(n("textarea",{"onUpdate:modelValue":u[0]||(u[0]=p=>v.value=p),placeholder:"Nhập tin nhắn...",class:D(["w-full border-gray-200 border rounded-2xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-none bg-gray-50",{"h-10":S.value===1,"h-20":S.value>1}]),onKeydown:oe(z(I,["prevent"]),["enter"]),onInput:w,ref_key:"textarea",ref:x},null,42,Ue),[[ee,v.value]])]),n("button",{type:"submit",class:D(["bg-blue-500 hover:bg-blue-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-sm transition-colors",{"opacity-50 cursor-not-allowed":!f.value,"hover:shadow-md":f.value}]),disabled:!f.value},u[1]||(u[1]=[n("i",{class:"fab fa-telegram-plane"},null,-1)]),10,De)],32)]))}},je={class:"h-full flex bg-white shadow-md rounded-lg overflow-hidden"},Ae={class:"w-1/3 border-r border-gray-100 flex flex-col"},Be={class:"py-3 px-4 border-b border-gray-100 bg-white"},He={class:"relative mt-2"},Re={class:"flex-1 overflow-y-auto"},Oe={key:0,class:"p-4 text-center"},Ee={key:1,class:"p-4 text-center"},Fe={class:"w-2/3 flex flex-col"},Ve={class:"py-3 px-4 border-b border-gray-100 flex items-center justify-between bg-white shadow-sm"},qe={class:"flex items-center"},We={class:"w-10 h-10 bg-blue-100 rounded-md flex items-center justify-center overflow-hidden mr-3"},Pe=["src"],Ye={key:1,class:"w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 rounded-md flex items-center justify-center text-white font-bold"},Ke={class:"font-medium text-gray-800"},ze={key:0,class:"text-xs text-green-500"},Qe={key:1,class:"py-2 text-center mb-2"},Ge={key:2,class:"my-auto text-center"},Je={key:3,class:"my-auto text-center py-12"},Ze={class:"flex flex-col space-y-2"},Xe={key:0,class:"py-2 text-center"},et={key:1,class:"flex-1 flex items-center justify-center flex-col p-4"},at={__name:"ChatContainer",setup(l){const t=ie(),y=le(),m=ce(),v=ue(),x=$(""),S=$(null),f=$(null),M=$(!1),I=$(!0),w=Z("chatUserId",null),r=A(()=>{var e;return(e=y.userInfo)==null?void 0:e.user_id});F(()=>v.query.user,e=>{if(e){const s=parseInt(e,10);isNaN(s)||V(s)}},{immediate:!1});const u=A(()=>{if(!t.conversations.length)return[];const e=new Map;return t.conversations.forEach(a=>{const g=a.sender===r.value?a.recipient:a.sender,o=typeof g=="string"?parseInt(g,10):g,k=t.userInfoCache[o];let h=t.lastMessages[o];if(h){const O=typeof h.sender=="string"?parseInt(h.sender,10):h.sender,K=typeof h.recipient=="string"?parseInt(h.recipient,10):h.recipient;O===r.value&&K===o||O===o&&K===r.value||(h=null)}let j="";k&&k.fullname?j=k.fullname:h&&h.recipient_fullname&&o!==r.value?j=h.recipient_fullname:h&&h.sender_fullname?j=h.sender_fullname:j=`Người dùng #${o}`,e.has(o)||e.set(o,{userId:o,displayName:j,avatar:(k==null?void 0:k.avatar)||null,isOnline:!1,lastMessage:(h==null?void 0:h.content)||"",lastMessageTime:(h==null?void 0:h.created_at)||"",unreadCount:0})}),Array.from(e.values()).sort((a,i)=>a.lastMessageTime?i.lastMessageTime?new Date(i.lastMessageTime)-new Date(a.lastMessageTime):-1:1)}),p=A(()=>{if(!x.value)return u.value;const e=x.value.toLowerCase();return u.value.filter(s=>s.displayName.toLowerCase().includes(e))}),b=A(()=>t.activeConversation?u.value.find(e=>e.userId===t.activeConversation):null),H=e=>{const s=e.userId,a=t.userInfoCache[s];return a&&a.fullname?(a.avatar&&e.avatar===null&&(e.avatar=a.avatar),a.fullname):e.displayName||`Người dùng #${e.userId}`},V=async e=>{if(t.activeConversation=e,S.value=e,!(t.activeConversation===e&&t.sortedMessages.length>0)){t.page=1,t.hasMoreMessages=!0;try{let s=!t.userInfoCache[e],a=null;s&&(a=t.fetchUserInfo(e));const i=await t.fetchMessages(e,!0);!i||i.length<20?t.hasMoreMessages=!1:t.hasMoreMessages=!0,await Promise.all([a].filter(Boolean)),await N(),await E(),setTimeout(()=>{T()},100)}catch(s){console.error("Lỗi khi tải tin nhắn:",s)}finally{t.loading=!1}}},N=async()=>{const e=t.sortedMessages.filter(s=>!s.is_read&&s.sender!==r.value);if(e.length>0)for(const s of e)try{await t.markMessageAsRead(s.id)}catch(a){console.error(`Lỗi khi đánh dấu tin nhắn ${s.id} là đã đọc:`,a)}},L=async e=>{if(t.activeConversation)try{const s=await t.sendMessage(t.activeConversation,e),a=u.value.find(i=>i.userId===t.activeConversation);a&&(a.lastMessage=e,a.lastMessageTime=new Date().toISOString()),setTimeout(async()=>{try{await t.fetchLatestMessages()}catch(i){console.error("Lỗi khi tải tin nhắn mới nhất sau khi gửi:",i)}},500),setTimeout(()=>{const i=t.sortedMessages[t.sortedMessages.length-1];i&&i.content===e||s&&(t.addMessage({...s,is_read:!0}),t.sortConversationToTop(s))},500),await E(),T()}catch(s){console.error("Lỗi khi gửi tin nhắn:",s)}},T=()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight,setTimeout(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)},100))},te=async()=>{if(!f.value||!t.activeConversation)return;const{scrollTop:e,clientHeight:s,scrollHeight:a}=f.value;if(I.value=a-e-s<100,e<=20&&!M.value&&t.hasMoreMessages){const i=a;M.value=!0;try{if(await t.fetchMessages(t.activeConversation),await E(),f.value){const k=f.value.scrollHeight-i+20;f.value.scrollTop=k}}catch(g){console.error("Lỗi khi tải thêm tin nhắn cũ hơn:",g)}finally{setTimeout(()=>{M.value=!1},500)}}};F(()=>JSON.stringify(t.sortedMessages),()=>{if(N(),f.value){const{scrollTop:e,scrollHeight:s,clientHeight:a}=f.value,i=s-e-a<300,g=t.sortedMessages[t.sortedMessages.length-1],o=g&&g.sender===r.value;(i||o)&&(T(),E(()=>{T()}))}}),F(()=>t.sortedMessages.length,(e,s)=>{var a;if(e>s){const i=t.sortedMessages[t.sortedMessages.length-1];if(i&&f.value){if(i.sender!==r.value){const O=t.userInfoCache[i.sender];O&&O.avatar&&!((a=t.activeConversation)!=null&&a.avatar)&&t.activeConversation&&(t.activeConversation.avatar=O.avatar)}const{scrollTop:g,scrollHeight:o,clientHeight:k}=f.value,h=o-g-k<300,j=i.sender===r.value;(h||j)&&T()}}}),F(()=>t.activeConversation,(e,s)=>{e!==s&&E(()=>{T()})}),F(()=>t.sortedMessages,(e,s)=>{if(e.length>s.length){const a=e[e.length-1];t.activeConversation===a.sender&&a.recipient===r.value&&!a.is_read&&t.markMessageAsRead(a.id)}},{deep:!0});const P=e=>{var s;if(e&&e.type==="chat_message"){const a=e.message;t.addMessage(a);const i=(s=y.userInfo)==null?void 0:s.user_id;if(a.sender!==i&&t.activeConversation!==a.sender){const g=t.userInfoCache[a.sender],o=(g==null?void 0:g.fullname)||`Người dùng #${a.sender}`;m.createMessageNotification(a.sender,a.content,o)}if(t.activeConversation===a.sender){t.markMessageAsRead(a.id);const g=u.value.find(o=>o.userId===a.sender);g&&(g.lastMessage=a.content,g.lastMessageTime=a.created_at),E(()=>{T()})}setTimeout(async()=>{try{await t.fetchLatestMessages()}catch(g){console.error("Lỗi khi tải tin nhắn mới nhất sau khi nhận tin nhắn socket:",g)}},500)}},se=e=>{console.warn("Lỗi khi tải avatar trong header:",e),e.target.src="",W();const s=Y(),a=e.target.closest(".overflow-hidden");if(a){const i=document.createElement("div");i.className="w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 flex items-center justify-center text-white font-bold",i.textContent=s,a.appendChild(i),e.target.style.display="none"}b.value&&(b.value.avatar=null)},ae=e=>{if(!e)return!1;try{return e.startsWith("src/assets/")||e.startsWith("/src/assets/")?(console.error("Đường dẫn avatar assets không tồn tại:",e),!1):(new URL(e),e.match(/\.(jpeg|jpg|gif|png|webp)$/i)||e.includes("cloudinary.com")||e.includes("res.cloudinary.com"),!0)}catch{return console.error("URL avatar không hợp lệ:",e),!1}},W=()=>{if(!t.activeConversation)return"Chọn một cuộc trò chuyện";const e=t.activeConversation,s=t.userInfoCache[e];if(s&&s.fullname)return s.fullname;const a=u.value.find(i=>i.userId===e);return a&&a.displayName?a.displayName:`Người dùng #${e}`},Y=()=>{const e=W();return!e||e.startsWith("Người dùng #")?"?":e.trim().charAt(0).toUpperCase()};de(async()=>{ne();let e=null;v.query.user?e=parseInt(v.query.user,10):w&&(e=w);try{await Promise.all([t.fetchConversations(),t.fetchUnreadMessages()]),await t.fetchLatestMessages(),e&&!isNaN(e)&&await V(e),re()}catch(s){console.error("Lỗi khi khởi tạo ChatContainer:",s)}_.onMessage(P)});const ne=()=>{_.init(),setTimeout(()=>{_.connected||(_.disconnect(),_.init())},2e3)};let R=null;const re=()=>{R&&clearInterval(R),R=setInterval(()=>{_.connected||_.init()},3e4)};return fe(()=>{R&&(clearInterval(R),R=null),_.disconnect(),_.offMessage(P)}),(e,s)=>{var a,i,g;return c(),d("div",je,[n("div",Ae,[n("div",Be,[s[2]||(s[2]=n("h2",{class:"text-lg font-semibold text-gray-800"},"Tin nhắn",-1)),n("div",He,[X(n("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=o=>x.value=o),placeholder:"Tìm kiếm cuộc trò chuyện...",class:"w-full border-gray-200 border rounded-xl pl-9 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-gray-50"},null,512),[[ee,x.value]]),s[1]||(s[1]=n("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[n("i",{class:"fas fa-search"})],-1))])]),n("div",Re,[C(t).loading&&!C(t).activeConversation?(c(),d("div",Oe,s[3]||(s[3]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải danh sách...",-1)]))):p.value.length===0?(c(),d("div",Ee,s[4]||(s[4]=[n("i",{class:"fas fa-comments text-gray-300 text-4xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Không có cuộc trò chuyện nào",-1)]))):(c(!0),d(q,{key:2},Q(p.value,o=>(c(),G($e,{key:o.id,"display-name":H(o),avatar:o.avatar,"last-message":o.lastMessage,"last-message-time":o.lastMessageTime,"unread-count":o.unreadCount,"is-online":o.isOnline,"is-active":C(t).activeConversation===o.userId,userId:o.userId,onSelect:k=>V(o.userId)},null,8,["display-name","avatar","last-message","last-message-time","unread-count","is-online","is-active","userId","onSelect"]))),128))])]),n("div",Fe,[C(t).activeConversation?(c(),d(q,{key:0},[n("div",Ve,[n("div",qe,[n("div",We,[(a=b.value)!=null&&a.avatar&&ae((i=b.value)==null?void 0:i.avatar)?(c(),d("img",{key:0,src:b.value.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:se},null,40,Pe)):(c(),d("div",Ye,U(Y()),1))]),n("div",null,[n("h3",Ke,U(W()),1),(g=b.value)!=null&&g.isOnline?(c(),d("p",ze,s[5]||(s[5]=[n("i",{class:"fas fa-circle mr-1 text-[8px]"},null,-1),J(" Đang hoạt động ")]))):B("",!0)])])]),n("div",{class:"flex-1 p-4 overflow-y-auto flex flex-col relative bg-gray-50",ref_key:"messagesContainer",ref:f,onScroll:te},[!I.value&&C(t).sortedMessages.length>5?(c(),d("button",{key:0,onClick:T,class:"absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 shadow-md z-10 transition-colors",title:"Cuộn xuống tin nhắn mới nhất"},s[6]||(s[6]=[n("i",{class:"fas fa-arrow-down"},null,-1)]))):B("",!0),M.value?(c(),d("div",Qe,s[7]||(s[7]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải thêm tin nhắn cũ hơn...",-1)]))):B("",!0),C(t).loading&&!C(t).sortedMessages.length?(c(),d("div",Ge,s[8]||(s[8]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải tin nhắn...",-1),n("p",{class:"text-xs text-gray-400 mt-1"},"Đang tải nhiều trang để hiển thị đầy đủ cuộc trò chuyện",-1)]))):C(t).sortedMessages.length?(c(),d(q,{key:4},[n("div",Ze,[(c(!0),d(q,null,Q(C(t).sortedMessages,o=>(c(),G(pe,{key:o.id,content:o.content,"is-current-user":o.sender===r.value,"is-read":o.is_read,"created-at":o.created_at},null,8,["content","is-current-user","is-read","created-at"]))),128))]),C(t).loading&&C(t).sortedMessages.length?(c(),d("div",Xe,s[10]||(s[10]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải tin nhắn...",-1)]))):B("",!0)],64)):(c(),d("div",Je,s[9]||(s[9]=[n("i",{class:"fas fa-comment-dots text-gray-300 text-5xl mb-3"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Chưa có tin nhắn. Hãy gửi tin nhắn đầu tiên!",-1)])))],544),ge(Le,{loading:C(t).loading,onSendMessage:L},null,8,["loading"])],64)):(c(),d("div",et,s[11]||(s[11]=[n("i",{class:"fas fa-comments text-gray-300 text-6xl mb-4"},null,-1),n("h3",{class:"text-xl font-medium text-gray-700 mb-2"},"Trò chuyện của bạn",-1),n("p",{class:"text-gray-500 text-center max-w-md"}," Chọn một cuộc trò chuyện từ danh sách bên trái hoặc bắt đầu một cuộc trò chuyện mới. ",-1)])))])])}}};export{at as _};
