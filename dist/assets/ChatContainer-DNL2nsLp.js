import{E as V,c as i,o,d as s,t as T,n as $,e as K,b as N,_ as Z,j as U,Z as de,G as R,m as Q,v as J,M as ve,q as le,P as E,V as me,h as ye,T as pe,B as xe,k as be,y as we,l as C,F as O,g as Y,f as ie,s as G,Q as W}from"./index-BC0viRdf.js";const Ce={class:"whitespace-pre-wrap text-[15px]"},Me={key:0,class:"ml-1"},ke={key:0,class:"fas fa-check-double"},Se={key:1,class:"fas fa-check"},ce={__name:"ChatMessage",props:{content:{type:String,required:!0},isCurrentUser:{type:Boolean,default:!1},isRead:{type:Boolean,default:!1},createdAt:{type:[String,Date],required:!0}},setup(u){const n=u,M=V(()=>{const p=new Date(n.createdAt);if(isNaN(p.getTime()))return"";const g=new Date,j=g-p,f=Math.floor(j/(1e3*60*60)),I=Math.floor(j/(1e3*60*60*24)),B=p.getHours().toString().padStart(2,"0"),v=p.getMinutes().toString().padStart(2,"0"),D=`${B}:${v}`;if(f<24&&p.getDate()===g.getDate())return D;if(I<7)return`${["CN","T2","T3","T4","T5","T6","T7"][p.getDay()]} ${D}`;if(p.getFullYear()===g.getFullYear()){const x=p.getDate().toString().padStart(2,"0"),H=(p.getMonth()+1).toString().padStart(2,"0");return`${x}/${H} ${D}`}const l=p.getDate().toString().padStart(2,"0"),y=(p.getMonth()+1).toString().padStart(2,"0"),S=p.getFullYear();return`${l}/${y}/${S} ${D}`});return(p,g)=>(o(),i("div",{class:$(["flex",u.isCurrentUser?"justify-end":"justify-start","mb-3"])},[s("div",{class:$(["max-w-[70%] rounded-2xl px-4 py-2.5 break-words shadow-sm",u.isCurrentUser?"bg-blue-500 text-white rounded-br-none":"bg-gray-100 text-gray-800 rounded-bl-none"])},[s("p",Ce,T(u.content),1),s("div",{class:$(["text-xs mt-1 flex justify-end items-center",u.isCurrentUser?"text-blue-100":"text-gray-500"])},[K(T(M.value)+" ",1),u.isCurrentUser?(o(),i("span",Me,[u.isRead?(o(),i("i",ke)):(o(),i("i",Se))])):N("",!0)],2)],2)],2))}},_e={class:"flex-shrink-0 mr-3 relative"},Te={key:0,class:"w-12 h-12 rounded-md overflow-hidden shadow-sm"},$e=["src"],Ie={key:1,class:"w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-md flex items-center justify-center text-white font-bold shadow-sm"},De={key:2,class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"},Ne={key:3,class:"absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"},Ue={class:"flex-1 min-w-0"},je={class:"flex justify-between items-center"},Ae={class:"flex items-center mt-1"},Be={__name:"ChatConversation",props:{displayName:{type:String,required:!0},avatar:{type:String,default:null},lastMessage:{type:String,default:""},lastMessageTime:{type:String,default:""},unreadCount:{type:Number,default:0},isOnline:{type:Boolean,default:!1},isActive:{type:Boolean,default:!1},isRead:{type:Boolean,default:!0},userId:{type:[Number,String],required:!0},openInPopup:{type:Boolean,default:!1}},emits:["select"],setup(u,{emit:n}){const M=u,p=n,g=U(!1),j=de("openChat",null),f=l=>{if(!l)return!1;try{if(l.startsWith("src/assets/")||l.startsWith("/src/assets/"))return console.error("Đường dẫn avatar assets không tồn tại:",l),!1;const y=new URL(l);return l.match(/\.(jpeg|jpg|gif|png|webp)$/i)||l.includes("cloudinary.com")||l.includes("res.cloudinary.com"),!0}catch(y){return console.error("URL avatar không hợp lệ:",l,y),!1}},I=l=>{console.warn("Lỗi khi tải avatar:",M.avatar),g.value=!0,l.target.src="";try{const y=l.target.closest(".rounded-md");if(y){l.target.style.display="none";const S=document.createElement("div");S.className="w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 flex items-center justify-center text-white font-bold",S.textContent=v(M.displayName),y.appendChild(S),console.log(`Đã thay thế avatar lỗi cho ${M.displayName} với initials: ${v(M.displayName)}`)}}catch(y){console.error("Lỗi khi xử lý DOM sau lỗi avatar:",y)}},B=V(()=>{if(!M.lastMessageTime)return"";const l=new Date(M.lastMessageTime),y=new Date,S=y-l,x=Math.floor(S/(1e3*60)),H=Math.floor(S/(1e3*60*60)),_=Math.floor(S/(1e3*60*60*24));if(x<1)return"Vừa xong";if(x<60)return`${x} phút`;if(H<24&&l.getDate()===y.getDate()){const b=l.getHours().toString().padStart(2,"0"),A=l.getMinutes().toString().padStart(2,"0");return`${b}:${A}`}else{if(_<7)return["CN","T2","T3","T4","T5","T6","T7"][l.getDay()];if(l.getFullYear()===y.getFullYear()){const b=l.getDate().toString().padStart(2,"0"),A=(l.getMonth()+1).toString().padStart(2,"0");return`${b}/${A}`}else{const b=l.getDate().toString().padStart(2,"0"),A=(l.getMonth()+1).toString().padStart(2,"0"),k=l.getFullYear().toString().slice(2);return`${b}/${A}/${k}`}}}),v=l=>l?l.trim().charAt(0).toUpperCase():"?",D=()=>{M.openInPopup&&j?j(M.userId):p("select")};return(l,y)=>(o(),i("div",{class:$(["flex items-center px-4 py-3 cursor-pointer transition-colors border-b border-gray-100",{"bg-blue-50":u.isActive,"hover:bg-gray-50":!u.isActive&&u.unreadCount===0,"hover:bg-blue-25":!u.isActive&&u.unreadCount>0,"border-l-4 border-l-blue-500":u.isActive,"border-l-4 border-l-red-400":!u.isActive&&u.unreadCount>0,"bg-red-25":!u.isActive&&u.unreadCount>0}]),onClick:D},[s("div",_e,[u.avatar&&f(u.avatar)?(o(),i("div",Te,[s("img",{src:u.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:I},null,40,$e)])):(o(),i("div",Ie,T(v(u.displayName)),1)),u.isOnline?(o(),i("div",De)):N("",!0),u.unreadCount>0?(o(),i("div",Ne)):N("",!0)]),s("div",Ue,[s("div",je,[s("h3",{class:$(["text-sm truncate",[u.unreadCount>0?"text-gray-900 font-bold":"text-gray-700 font-medium"]])},T(u.displayName||`Người dùng #${u.userId}`),3),s("span",{class:$(["text-xs",[u.unreadCount>0?"text-red-600 font-bold":"text-gray-500"]])},T(B.value),3)]),s("div",Ae,[s("p",{class:$(["text-sm truncate flex-1",{"text-gray-900 font-semibold":u.unreadCount>0,"text-gray-500":u.unreadCount===0}])},T(u.lastMessage),3)])])],2))}},He=Z(Be,[["__scopeId","data-v-205b853c"]]),Fe={class:"border-t border-gray-100 py-3 px-4 bg-white shadow-lg"},Le={class:"relative flex-1"},We=["onKeydown","disabled"],Oe={key:0,class:"absolute bottom-2 right-2 text-xs text-gray-400 hidden lg:block"},Re={class:"relative flex-shrink-0"},Ee=["disabled","title"],Ve={key:0,class:"animate-spin"},qe={key:1,class:"relative"},Ye={key:0,class:"absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white flex items-center justify-center",title:"Mất kết nối mạng"},Ke={__name:"ChatInput",props:{loading:{type:Boolean,default:!1}},emits:["send-message"],setup(u,{emit:n}){const M=u,p=n,g=U(""),j=U(null),f=U(1),I=U(!0),B=U(!1),v=V(()=>g.value.trim().length>0&&!M.loading&&g.value.length<=1e3),D=()=>{v.value&&(p("send-message",g.value.trim()),g.value="",f.value=1,setTimeout(()=>{j.value&&j.value.focus()},10))},l=_=>{_.shiftKey||D()},y=()=>{B.value=!0},S=()=>{B.value=!1},x=()=>{const _=g.value.split(`
`);f.value=Math.min(_.length,6)},H=()=>{const _=E.connected;I.value=_,console.log(`Trạng thái kết nối WebSocket: ${_?"Đã kết nối":"Đã ngắt kết nối"}`),_?E.sendMessage({type:"ping",data:{timestamp:new Date().toISOString()}}):(console.log("Đang thử kết nối lại WebSocket..."),E.init(),setTimeout(()=>{E.connected?(console.log("Kết nối WebSocket thành công, đang gửi tin nhắn ping..."),E.sendMessage({type:"ping",data:{timestamp:new Date().toISOString()}})):console.log("Không thể kết nối WebSocket")},1e3))};return R(g,()=>{x()}),setInterval(H,3e4),(_,b)=>(o(),i("div",Fe,[s("form",{onSubmit:le(D,["prevent"]),class:"flex items-end gap-2 max-w-4xl mx-auto"},[s("div",Le,[Q(s("textarea",{"onUpdate:modelValue":b[0]||(b[0]=A=>g.value=A),placeholder:"Nhập tin nhắn của bạn...",class:$(["w-full border-2 border-gray-200 rounded-2xl px-4 py-3 pr-12 focus:outline-none focus:ring-0 focus:border-blue-400 resize-none bg-white transition-all duration-200 ease-in-out shadow-sm hover:shadow-md text-gray-700 placeholder-gray-400",{"h-11":f.value===1,"h-20":f.value===2,"h-28":f.value===3,"h-36":f.value>=4}]),onKeydown:ve(le(l,["prevent"]),["enter"]),onInput:x,onFocus:y,onBlur:S,ref_key:"textarea",ref:j,disabled:M.loading,rows:"1"},null,42,We),[[J,g.value]]),B.value&&g.value.length>0?(o(),i("div",Oe,b[1]||(b[1]=[s("span",{class:"bg-gray-100 px-2 py-1 rounded-full"},[s("i",{class:"fas fa-level-down-alt mr-1"}),K(" Shift + Enter để xuống dòng ")],-1)]))):N("",!0),g.value.length>500?(o(),i("div",{key:1,class:$(["absolute top-2 right-2 text-xs",g.value.length>1e3?"text-red-500":"text-orange-500"])},T(g.value.length)+"/1000 ",3)):N("",!0)]),s("div",Re,[s("button",{type:"submit",class:$(["group relative bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg transition-all duration-200 ease-in-out transform",{"opacity-50 cursor-not-allowed":!v.value,"hover:scale-105 hover:shadow-xl active:scale-95":v.value,"animate-pulse":M.loading}]),disabled:!v.value,title:v.value?"Gửi tin nhắn":"Nhập tin nhắn để gửi"},[M.loading?(o(),i("div",Ve,b[2]||(b[2]=[s("i",{class:"fas fa-circle-notch text-base"},null,-1)]))):(o(),i("div",qe,[s("i",{class:$(["fas fa-paper-plane text-base transition-transform duration-200 group-hover:translate-x-0.5 group-hover:-translate-y-0.5",{"text-blue-200":!v.value}])},null,2)])),b[3]||(b[3]=s("div",{class:"absolute inset-0 rounded-full bg-white opacity-0 group-active:opacity-20 transition-opacity duration-150"},null,-1))],10,Ee),I.value?N("",!0):(o(),i("div",Ye,b[4]||(b[4]=[s("i",{class:"fas fa-exclamation text-xs text-white"},null,-1)])))])],32)]))}},ue=Z(Ke,[["__scopeId","data-v-926ac8a7"]]),Pe={class:"h-full md:hidden"},ze={key:0,class:"h-full flex flex-col bg-white"},Ge={class:"py-4 px-4 border-b border-gray-100 bg-white"},Qe={class:"relative"},Je={class:"flex-1 overflow-y-auto"},Ze={key:0,class:"p-6 text-center"},Xe={key:1,class:"p-6 text-center"},et=["onClick"],tt={class:"flex-shrink-0 mr-3 relative"},st={key:0,class:"w-12 h-12 rounded-full overflow-hidden shadow-sm"},nt=["src"],at={key:1,class:"w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold shadow-sm"},ot={class:"flex-1 min-w-0"},rt={class:"flex justify-between items-center mb-1"},lt={key:1,class:"h-full flex flex-col bg-white"},it={class:"py-3 px-4 border-b border-gray-100 flex items-center bg-white shadow-sm"},ct={class:"flex items-center flex-1"},ut={class:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center overflow-hidden mr-3"},dt=["src"],ft={key:1,class:"w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold"},gt={class:"font-medium text-gray-800"},ht={key:0,class:"text-xs text-green-500"},vt={key:0,class:"py-2 text-center mb-2"},mt={key:1,class:"my-auto text-center"},yt={key:2,class:"my-auto text-center py-12"},pt={key:3,class:"flex flex-col space-y-3"},xt={class:"h-full hidden md:flex bg-white shadow-md rounded-lg overflow-hidden"},bt={class:"w-1/3 border-r border-gray-100 flex flex-col"},wt={class:"py-3 px-4 border-b border-gray-100 bg-white"},Ct={class:"relative mt-2"},Mt={class:"flex-1 overflow-y-auto"},kt={key:0,class:"p-4 text-center"},St={key:1,class:"p-4 text-center"},_t={class:"w-2/3 flex flex-col"},Tt={class:"py-3 px-4 border-b border-gray-100 flex items-center justify-between bg-white shadow-sm"},$t={class:"flex items-center"},It={class:"w-10 h-10 bg-blue-100 rounded-md flex items-center justify-center overflow-hidden mr-3"},Dt=["src"],Nt={key:1,class:"w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 rounded-md flex items-center justify-center text-white font-bold"},Ut={class:"font-medium text-gray-800"},jt={key:0,class:"text-xs text-green-500"},At={key:1,class:"py-2 text-center mb-2"},Bt={key:2,class:"my-auto text-center"},Ht={key:3,class:"my-auto text-center py-12"},Ft={class:"flex flex-col space-y-2"},Lt={key:0,class:"py-2 text-center"},Wt={key:1,class:"flex-1 flex items-center justify-center flex-col p-4"},Ot={__name:"ChatContainer",setup(u){const n=me(),M=ye();pe();const p=xe(),g=U(""),j=U(null),f=U(null),I=U(!1),B=U(!0),v=U(!1),D=de("chatUserId",null),l=V(()=>{var t;return(t=M.userInfo)==null?void 0:t.user_id});R(()=>p.query.user,t=>{if(t){const e=parseInt(t,10);isNaN(e)||(window.innerWidth<768?ne(e):_(e))}},{immediate:!1}),R(()=>v.value,t=>{typeof window<"u"&&t&&(history.pushState({mobileChat:!0},"",window.location.href),W(()=>{setTimeout(()=>{k()},150)}))}),typeof window<"u"&&window.addEventListener("popstate",t=>{window.innerWidth<768&&v.value&&(t.preventDefault(),ae())});const y=V(()=>{if(!n.conversations.length)return[];const t=new Map;return n.conversations.forEach(r=>{const m=r.sender===l.value?r.recipient:r.sender,h=typeof m=="string"?parseInt(m,10):m,w=n.userInfoCache[h];let c=n.lastMessages[h],a=0,L=!0;if(c){const oe=typeof c.sender=="string"?parseInt(c.sender,10):c.sender,re=typeof c.recipient=="string"?parseInt(c.recipient,10):c.recipient;oe===l.value&&re===h||oe===h&&re===l.value?(L=c.is_read,!c.is_read&&c.recipient===l.value&&c.sender!==l.value&&(a=1)):c=null}let F="";w&&w.fullname?F=w.fullname:c&&c.recipient_fullname&&h!==l.value?F=c.recipient_fullname:c&&c.sender_fullname?F=c.sender_fullname:F=`Người dùng #${h}`,t.has(h)||t.set(h,{userId:h,displayName:F,avatar:(w==null?void 0:w.avatar)||null,isOnline:!1,lastMessage:(c==null?void 0:c.content)||"",lastMessageTime:(c==null?void 0:c.created_at)||"",unreadCount:a,isRead:L})}),Array.from(t.values()).sort((r,d)=>r.lastMessageTime?d.lastMessageTime?new Date(d.lastMessageTime)-new Date(r.lastMessageTime):-1:1)}),S=V(()=>{if(!g.value)return y.value;const t=g.value.toLowerCase();return y.value.filter(e=>e.displayName.toLowerCase().includes(t))}),x=V(()=>n.activeConversation?y.value.find(t=>t.userId===n.activeConversation):null),H=t=>{const e=t.userId,r=n.userInfoCache[e];return r&&r.fullname?(r.avatar&&t.avatar===null&&(t.avatar=r.avatar),r.fullname):t.displayName||`Người dùng #${t.userId}`},_=async t=>{console.log(`🚀 [selectConversation] Selecting conversation with user ${t}`),n.activeConversation=t,j.value=t,n.page=1,n.hasMoreMessages=!0;try{console.log(`📥 [selectConversation] Fetching messages for user ${t}...`);const e=await n.fetchMessages(t,!0);console.log(`✅ [selectConversation] Loaded ${(e==null?void 0:e.length)||0} messages`),!e||e.length<20?n.hasMoreMessages=!1:n.hasMoreMessages=!0,await b(),await W(),v.value?(setTimeout(()=>{console.log("📱 [selectConversation Mobile] Scrolling to bottom..."),k()},200),setTimeout(()=>{console.log("📱 [selectConversation Mobile] Final scroll..."),k()},500)):setTimeout(()=>{console.log("💻 [selectConversation Desktop] Scrolling to bottom..."),k()},100)}catch(e){console.error("❌ [selectConversation] Lỗi khi tải tin nhắn:",e)}finally{n.loading=!1}},b=async()=>{const t=n.sortedMessages.filter(e=>!e.is_read&&e.sender!==l.value);if(t.length>0)for(const e of t)try{await n.markMessageAsRead(e.id)}catch(r){console.error(`Lỗi khi đánh dấu tin nhắn ${e.id} là đã đọc:`,r)}},A=async t=>{if(n.activeConversation)try{const e=await n.sendMessage(n.activeConversation,t),r=y.value.find(d=>d.userId===n.activeConversation);r&&(r.lastMessage=t,r.lastMessageTime=new Date().toISOString()),await W(),k(),setTimeout(async()=>{try{await n.fetchLatestMessages()}catch(d){console.error("Lỗi khi tải tin nhắn mới nhất sau khi gửi:",d)}},500)}catch(e){console.error("Lỗi khi gửi tin nhắn:",e)}},k=()=>{f.value?(console.log("🔄 [scrollToBottom] Bắt đầu cuộn xuống..."),f.value.scrollTop=f.value.scrollHeight,setTimeout(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight,console.log(`📍 [scrollToBottom] Đã cuộn xuống - scrollTop: ${f.value.scrollTop}, scrollHeight: ${f.value.scrollHeight}`))},100),v.value&&setTimeout(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight,console.log(`📱 [scrollToBottom Mobile] Final scroll - scrollTop: ${f.value.scrollTop}`))},300)):console.warn("⚠️ [scrollToBottom] messagesContainer.value is null")},X=async()=>{if(!f.value||!n.activeConversation)return;const{scrollTop:t,clientHeight:e,scrollHeight:r}=f.value;if(B.value=r-t-e<100,t<=20&&!I.value&&n.hasMoreMessages){const d=r;I.value=!0;try{if(await n.fetchMessages(n.activeConversation),await W(),f.value){const w=f.value.scrollHeight-d+20;f.value.scrollTop=w}}catch(m){console.error("Lỗi khi tải thêm tin nhắn cũ hơn:",m)}finally{setTimeout(()=>{I.value=!1},500)}}},ee=t=>{if(!t||!t.created_at)return!1;const e=new Date(t.created_at);return new Date-e<1e4};R(()=>JSON.stringify(n.sortedMessages),()=>{if(console.log(`📝 [Messages Watcher] Messages changed, length: ${n.sortedMessages.length}`),b(),f.value&&!I.value){const{scrollTop:t,scrollHeight:e,clientHeight:r}=f.value,d=e-t-r<300,m=n.sortedMessages[n.sortedMessages.length-1],h=m&&m.sender===l.value,w=m&&ee(m);console.log(`📊 [Messages Watcher] isNearBottom: ${d}, isFromCurrentUser: ${h}, isRecent: ${w}, isMobile: ${v.value}`),(d&&w||h||v.value)&&(console.log("✅ [Messages Watcher] Scrolling to bottom..."),k(),W(()=>{k()}))}}),R(()=>n.sortedMessages.length,(t,e)=>{var r;if(t>e&&!I.value){const d=n.sortedMessages[n.sortedMessages.length-1];if(d&&f.value){if(d.sender!==l.value){const F=n.userInfoCache[d.sender];F&&F.avatar&&!((r=n.activeConversation)!=null&&r.avatar)&&n.activeConversation&&(n.activeConversation.avatar=F.avatar)}const{scrollTop:m,scrollHeight:h,clientHeight:w}=f.value,c=h-m-w<300,a=d.sender===l.value,L=ee(d);(a||c&&L)&&k()}}}),R(()=>n.activeConversation,(t,e)=>{t!==e&&W(()=>{k(),v.value&&setTimeout(()=>{k()},200)})}),R(()=>n.sortedMessages,(t,e)=>{if(t.length>e.length){const r=t[t.length-1];n.activeConversation===r.sender&&r.recipient===l.value&&!r.is_read&&n.markMessageAsRead(r.id)}},{deep:!0});const te=t=>{var e,r;if(t&&(t.type==="new_message"||t.data&&t.data.type==="new_message")){const d=((e=t.data)==null?void 0:e.type)==="new_message"?t.data:t,m=(r=M.userInfo)==null?void 0:r.user_id;if(m){const h={sender:parseInt(d.sender_id,10),recipient:parseInt(d.recipient_id,10)},w=m===h.sender?h.recipient:h.sender;n.activeConversation===w&&W(()=>{k()})}}},se=t=>{console.warn("Lỗi khi tải avatar trong header:",t),t.target.src="",q();const e=z(),r=t.target.closest(".overflow-hidden");if(r){const d=document.createElement("div");d.className="w-full h-full bg-gradient-to-r from-blue-400 to-blue-500 flex items-center justify-center text-white font-bold",d.textContent=e,r.appendChild(d),t.target.style.display="none"}x.value&&(x.value.avatar=null)},fe=t=>{t.target.style.display="none"},P=t=>{if(!t)return!1;try{return t.startsWith("src/assets/")||t.startsWith("/src/assets/")?!1:(new URL(t),t.match(/\.(jpeg|jpg|gif|png|webp)$/i)||t.includes("cloudinary.com")||t.includes("res.cloudinary.com"),!0)}catch{return!1}},q=()=>{if(!n.activeConversation)return"Chọn một cuộc trò chuyện";const t=n.activeConversation,e=n.userInfoCache[t];if(e&&e.fullname)return e.fullname;const r=y.value.find(d=>d.userId===t);return r&&r.displayName?r.displayName:`Người dùng #${t}`},z=()=>{const t=q();return!t||t.startsWith("Người dùng #")?"?":t.trim().charAt(0).toUpperCase()},ne=async t=>{console.log(`📱 [openMobileChat] Opening mobile chat for user ${t}`),v.value=!0,await _(t),await W(),setTimeout(()=>{console.log("📱 [openMobileChat] First scroll attempt..."),k()},100),setTimeout(()=>{console.log("📱 [openMobileChat] Second scroll attempt..."),k()},300),setTimeout(()=>{console.log("📱 [openMobileChat] Final scroll attempt..."),k()},600)},ae=()=>{v.value=!1,n.resetActiveConversation()},ge=t=>{if(!t)return"";const e=new Date(t),r=new Date,d=r-e,m=Math.floor(d/(1e3*60)),h=Math.floor(d/(1e3*60*60)),w=Math.floor(d/(1e3*60*60*24));if(m<1)return"Vừa xong";if(m<60)return`${m} phút`;if(h<24&&e.getDate()===r.getDate()){const c=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0");return`${c}:${a}`}else{if(w<7)return["CN","T2","T3","T4","T5","T6","T7"][e.getDay()];if(e.getFullYear()===r.getFullYear()){const c=e.getDate().toString().padStart(2,"0"),a=(e.getMonth()+1).toString().padStart(2,"0");return`${c}/${a}`}else{const c=e.getDate().toString().padStart(2,"0"),a=(e.getMonth()+1).toString().padStart(2,"0"),L=e.getFullYear().toString().slice(2);return`${c}/${a}/${L}`}}},he=t=>t?t.trim().charAt(0).toUpperCase():"?";return be(async()=>{let t=null;p.query.user?t=parseInt(p.query.user,10):D&&(t=D);try{await Promise.all([n.fetchConversations(),n.fetchUnreadMessages()]),await n.fetchLatestMessages(),t&&!isNaN(t)&&await _(t)}catch(e){console.error("Lỗi khi khởi tạo ChatContainer:",e)}E.onMessage(te)}),we(()=>{E.offMessage(te)}),(t,e)=>{var r,d,m,h,w,c;return o(),i(O,null,[s("div",Pe,[v.value?(o(),i("div",lt,[s("div",it,[s("button",{onClick:ae,class:"mr-3 p-2 rounded-full hover:bg-gray-100 transition-colors"},e[7]||(e[7]=[s("i",{class:"fas fa-arrow-left text-gray-600"},null,-1)])),s("div",ct,[s("div",ut,[(r=x.value)!=null&&r.avatar&&P((d=x.value)==null?void 0:d.avatar)?(o(),i("img",{key:0,src:x.value.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:se},null,40,dt)):(o(),i("div",ft,T(z()),1))]),s("div",null,[s("h3",gt,T(q()),1),(m=x.value)!=null&&m.isOnline?(o(),i("p",ht,e[8]||(e[8]=[s("i",{class:"fas fa-circle mr-1 text-[8px]"},null,-1),K(" Đang hoạt động ")]))):N("",!0)])])]),s("div",{class:"flex-1 p-4 overflow-y-auto flex flex-col relative bg-gray-50",ref_key:"messagesContainer",ref:f,onScroll:X},[I.value?(o(),i("div",vt,e[9]||(e[9]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),s("p",{class:"text-xs text-gray-500"},"Đang tải thêm tin nhắn cũ hơn...",-1)]))):N("",!0),C(n).loading&&!C(n).sortedMessages.length?(o(),i("div",mt,e[10]||(e[10]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Đang tải tin nhắn...",-1)]))):C(n).sortedMessages.length?(o(),i("div",pt,[(o(!0),i(O,null,Y(C(n).sortedMessages,a=>(o(),G(ce,{key:a.id,content:a.content,"is-current-user":a.sender===l.value,"is-read":a.is_read,"created-at":a.created_at},null,8,["content","is-current-user","is-read","created-at"]))),128))])):(o(),i("div",yt,e[11]||(e[11]=[s("i",{class:"fas fa-comment-dots text-gray-300 text-5xl mb-3"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Chưa có tin nhắn. Hãy gửi tin nhắn đầu tiên!",-1)])))],544),ie(ue,{loading:C(n).loading,onSendMessage:A},null,8,["loading"])])):(o(),i("div",ze,[s("div",Ge,[e[3]||(e[3]=s("h2",{class:"text-xl font-semibold text-gray-800 mb-3"},"Tin nhắn",-1)),s("div",Qe,[Q(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>g.value=a),placeholder:"Tìm kiếm cuộc trò chuyện...",class:"w-full border-gray-200 border rounded-xl pl-10 pr-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-gray-50"},null,512),[[J,g.value]]),e[2]||(e[2]=s("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[s("i",{class:"fas fa-search"})],-1))])]),s("div",Je,[C(n).loading&&!C(n).activeConversation?(o(),i("div",Ze,e[4]||(e[4]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-2xl"},null,-1),s("p",{class:"mt-3 text-gray-500"},"Đang tải danh sách...",-1)]))):S.value.length===0?(o(),i("div",Xe,e[5]||(e[5]=[s("i",{class:"fas fa-comments text-gray-300 text-5xl"},null,-1),s("p",{class:"mt-3 text-gray-500"},"Không có cuộc trò chuyện nào",-1)]))):(o(!0),i(O,{key:2},Y(S.value,a=>(o(),i("div",{key:a.id,class:$(["flex items-center px-4 py-4 cursor-pointer transition-colors border-b border-gray-50 hover:bg-gray-50",{"bg-blue-50 border-l-4 border-l-blue-500":C(n).activeConversation===a.userId,"border-l-4 border-l-red-400 bg-red-25":a.unreadCount>0}]),onClick:L=>ne(a.userId)},[s("div",tt,[a.avatar&&P(a.avatar)?(o(),i("div",st,[s("img",{src:a.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:fe},null,40,nt)])):(o(),i("div",at,T(he(H(a))),1))]),s("div",ot,[s("div",rt,[s("h3",{class:$(["text-base font-medium truncate",[a.unreadCount>0?"text-gray-900 font-semibold":"text-gray-700"]])},T(H(a)),3),s("span",{class:$(["text-sm",[a.unreadCount>0?"text-red-600 font-medium":"text-gray-500"]])},T(ge(a.lastMessageTime)),3)]),s("p",{class:$(["text-sm truncate",{"text-gray-900 font-medium":a.unreadCount>0,"text-gray-500":a.unreadCount===0}])},T(a.lastMessage||"Chưa có tin nhắn"),3)]),e[6]||(e[6]=s("div",{class:"ml-2"},[s("i",{class:"fas fa-chevron-right text-gray-400"})],-1))],10,et))),128))])]))]),s("div",xt,[s("div",bt,[s("div",wt,[e[13]||(e[13]=s("h2",{class:"text-lg font-semibold text-gray-800"},"Tin nhắn",-1)),s("div",Ct,[Q(s("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=a=>g.value=a),placeholder:"Tìm kiếm cuộc trò chuyện...",class:"w-full border-gray-200 border rounded-xl pl-9 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-gray-50"},null,512),[[J,g.value]]),e[12]||(e[12]=s("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[s("i",{class:"fas fa-search"})],-1))])]),s("div",Mt,[C(n).loading&&!C(n).activeConversation?(o(),i("div",kt,e[14]||(e[14]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Đang tải danh sách...",-1)]))):S.value.length===0?(o(),i("div",St,e[15]||(e[15]=[s("i",{class:"fas fa-comments text-gray-300 text-4xl"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Không có cuộc trò chuyện nào",-1)]))):(o(!0),i(O,{key:2},Y(S.value,a=>(o(),G(He,{key:a.id,"display-name":H(a),avatar:a.avatar,"last-message":a.lastMessage,"last-message-time":a.lastMessageTime,"unread-count":a.unreadCount,"is-online":a.isOnline,"is-active":C(n).activeConversation===a.userId,"is-read":a.isRead,userId:a.userId,onSelect:L=>_(a.userId)},null,8,["display-name","avatar","last-message","last-message-time","unread-count","is-online","is-active","is-read","userId","onSelect"]))),128))])]),s("div",_t,[C(n).activeConversation?(o(),i(O,{key:0},[s("div",Tt,[s("div",$t,[s("div",It,[(h=x.value)!=null&&h.avatar&&P((w=x.value)==null?void 0:w.avatar)?(o(),i("img",{key:0,src:x.value.avatar,alt:"Avatar",class:"w-full h-full object-cover",onError:se},null,40,Dt)):(o(),i("div",Nt,T(z()),1))]),s("div",null,[s("h3",Ut,T(q()),1),(c=x.value)!=null&&c.isOnline?(o(),i("p",jt,e[16]||(e[16]=[s("i",{class:"fas fa-circle mr-1 text-[8px]"},null,-1),K(" Đang hoạt động ")]))):N("",!0)])])]),s("div",{class:"flex-1 p-4 overflow-y-auto flex flex-col relative bg-gray-50",ref_key:"messagesContainer",ref:f,onScroll:X},[!B.value&&C(n).sortedMessages.length>5?(o(),i("button",{key:0,onClick:k,class:"absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 shadow-md z-10 transition-colors",title:"Cuộn xuống tin nhắn mới nhất"},e[17]||(e[17]=[s("i",{class:"fas fa-arrow-down"},null,-1)]))):N("",!0),I.value?(o(),i("div",At,e[18]||(e[18]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),s("p",{class:"text-xs text-gray-500"},"Đang tải thêm tin nhắn cũ hơn...",-1)]))):N("",!0),C(n).loading&&!C(n).sortedMessages.length?(o(),i("div",Bt,e[19]||(e[19]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Đang tải tin nhắn...",-1),s("p",{class:"text-xs text-gray-400 mt-1"},"Đang tải nhiều trang để hiển thị đầy đủ cuộc trò chuyện",-1)]))):C(n).sortedMessages.length?(o(),i(O,{key:4},[s("div",Ft,[(o(!0),i(O,null,Y(C(n).sortedMessages,a=>(o(),G(ce,{key:a.id,content:a.content,"is-current-user":a.sender===l.value,"is-read":a.is_read,"created-at":a.created_at},null,8,["content","is-current-user","is-read","created-at"]))),128))]),C(n).loading&&C(n).sortedMessages.length?(o(),i("div",Lt,e[21]||(e[21]=[s("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),s("p",{class:"text-xs text-gray-500"},"Đang tải tin nhắn...",-1)]))):N("",!0)],64)):(o(),i("div",Ht,e[20]||(e[20]=[s("i",{class:"fas fa-comment-dots text-gray-300 text-5xl mb-3"},null,-1),s("p",{class:"mt-2 text-gray-500"},"Chưa có tin nhắn. Hãy gửi tin nhắn đầu tiên!",-1)])))],544),ie(ue,{loading:C(n).loading,onSendMessage:A},null,8,["loading"])],64)):(o(),i("div",Wt,e[22]||(e[22]=[s("i",{class:"fas fa-comments text-gray-300 text-6xl mb-4"},null,-1),s("h3",{class:"text-xl font-medium text-gray-700 mb-2"},"Trò chuyện của bạn",-1),s("p",{class:"text-gray-500 text-center max-w-md"}," Chọn một cuộc trò chuyện từ danh sách bên trái hoặc bắt đầu một cuộc trò chuyện mới. ",-1)])))])])],64)}}},Vt=Z(Ot,[["__scopeId","data-v-42f7901a"]]);export{Vt as C};
