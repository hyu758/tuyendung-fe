import{E as A,c as l,a as i,e as n,t as D,n as _,f as E,d as B,Y as z,k as I,G as L,m as G,v as J,M as ee,q as V,U as te,i as se,B as ne,P as j,o as ae,O as $,y as oe,l as x,F as R,h as Y,s as K,g as re}from"./index-Hv-5ffem.js";const ie={class:"whitespace-pre-wrap text-[15px]"},le={key:0,class:"ml-1"},ce={key:0,class:"fas fa-check-double"},ue={key:1,class:"fas fa-check"},de={__name:"ChatMessage",props:{content:{type:String,required:!0},isCurrentUser:{type:Boolean,default:!1},isRead:{type:Boolean,default:!1},createdAt:{type:[String,Date],required:!0}},setup(r){const e=r,S=A(()=>{const g=new Date(e.createdAt);if(isNaN(g.getTime()))return"";const m=new Date,T=m-g,c=Math.floor(T/(1e3*60*60)),b=Math.floor(T/(1e3*60*60*24)),d=g.getHours().toString().padStart(2,"0"),y=g.getMinutes().toString().padStart(2,"0"),f=`${d}:${y}`;if(c<24&&g.getDate()===m.getDate())return f;if(b<7)return`${["CN","T2","T3","T4","T5","T6","T7"][g.getDay()]} ${f}`;if(g.getFullYear()===m.getFullYear()){const k=g.getDate().toString().padStart(2,"0"),C=(g.getMonth()+1).toString().padStart(2,"0");return`${k}/${C} ${f}`}const v=g.getDate().toString().padStart(2,"0"),w=(g.getMonth()+1).toString().padStart(2,"0"),U=g.getFullYear();return`${v}/${w}/${U} ${f}`});return(g,m)=>(i(),l("div",{class:_(["flex",r.isCurrentUser?"justify-end":"justify-start","mb-3"])},[n("div",{class:_(["max-w-[70%] rounded-2xl px-4 py-2.5 break-words shadow-sm",r.isCurrentUser?"bg-blue-500 text-white rounded-br-none":"bg-gray-100 text-gray-800 rounded-bl-none"])},[n("p",ie,D(r.content),1),n("div",{class:_(["text-xs mt-1 flex justify-end items-center",r.isCurrentUser?"text-blue-100":"text-gray-500"])},[E(D(S.value)+" ",1),r.isCurrentUser?(i(),l("span",le,[r.isRead?(i(),l("i",ce)):(i(),l("i",ue))])):B("",!0)],2)],2)],2))}},he={class:"flex-shrink-0 mr-3 relative"},ge={key:0,class:"w-12 h-12 rounded-full overflow-hidden shadow-sm"},fe=["src"],me={key:1,class:"w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold shadow-sm"},ye={key:2,class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"},ve={class:"flex-1 min-w-0"},xe={class:"flex justify-between items-center"},pe={class:"flex items-center mt-1"},be={key:0,class:"ml-2 bg-blue-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center shadow-sm"},ke={__name:"ChatConversation",props:{displayName:{type:String,required:!0},avatar:{type:String,default:null},lastMessage:{type:String,default:""},lastMessageTime:{type:String,default:""},unreadCount:{type:Number,default:0},isOnline:{type:Boolean,default:!1},isActive:{type:Boolean,default:!1},isRead:{type:Boolean,default:!0},userId:{type:[Number,String],required:!0},openInPopup:{type:Boolean,default:!1}},emits:["select"],setup(r,{emit:e}){const S=r,g=e,m=z("openChat",null),T=A(()=>{if(!S.lastMessageTime)return"";const d=new Date(S.lastMessageTime),y=new Date,f=y-d,v=Math.floor(f/(1e3*60)),w=Math.floor(f/(1e3*60*60)),U=Math.floor(f/(1e3*60*60*24));if(v<1)return"Vừa xong";if(v<60)return`${v} phút`;if(w<24&&d.getDate()===y.getDate()){const k=d.getHours().toString().padStart(2,"0"),C=d.getMinutes().toString().padStart(2,"0");return`${k}:${C}`}else{if(U<7)return["CN","T2","T3","T4","T5","T6","T7"][d.getDay()];if(d.getFullYear()===y.getFullYear()){const k=d.getDate().toString().padStart(2,"0"),C=(d.getMonth()+1).toString().padStart(2,"0");return`${k}/${C}`}else{const k=d.getDate().toString().padStart(2,"0"),C=(d.getMonth()+1).toString().padStart(2,"0"),F=d.getFullYear().toString().slice(2);return`${k}/${C}/${F}`}}}),c=d=>d?d.split(" ").filter(y=>y.length>0).map(y=>y.charAt(0).toUpperCase()).slice(0,2).join(""):"?",b=()=>{S.openInPopup&&m?m(S.userId):g("select")};return(d,y)=>(i(),l("div",{class:_(["flex items-center px-4 py-3 cursor-pointer transition-colors border-b border-gray-100",{"bg-blue-50":r.isActive,"hover:bg-gray-50":!r.isActive,"border-l-4 border-l-blue-500":r.isActive}]),onClick:b},[n("div",he,[r.avatar?(i(),l("div",ge,[n("img",{src:r.avatar,alt:"Avatar",class:"w-full h-full object-cover"},null,8,fe)])):(i(),l("div",me,D(c(r.displayName)),1)),r.isOnline?(i(),l("div",ye)):B("",!0)]),n("div",ve,[n("div",xe,[n("h3",{class:_(["text-sm font-medium truncate",[r.unreadCount>0?"text-gray-900 font-semibold":"text-gray-700"]])},D(r.displayName),3),n("span",{class:_(["text-xs text-gray-500",[r.unreadCount>0?"text-blue-600 font-semibold":"text-gray-500"]])},D(T.value),3)]),n("div",pe,[n("p",{class:_(["text-sm truncate flex-1",{"text-gray-700 font-medium":!r.isRead&&r.unreadCount>0,"text-gray-500":r.isRead||r.unreadCount===0}])},D(r.lastMessage),3),r.unreadCount>0?(i(),l("span",be,D(r.unreadCount>99?"99+":r.unreadCount),1)):B("",!0)])])],2))}},Ce={class:"border-t border-gray-100 py-3 px-4 bg-white"},Me={class:"relative flex-1"},we=["onKeydown"],Se=["disabled"],Te={__name:"ChatInput",props:{loading:{type:Boolean,default:!1}},emits:["send-message"],setup(r,{emit:e}){const S=r,g=e,m=I(""),T=I(null),c=I(1);I(!1);const b=A(()=>m.value.trim().length>0&&!S.loading),d=()=>{b.value&&(g("send-message",m.value.trim()),m.value="",c.value=1,setTimeout(()=>{T.value.focus()},10))},y=v=>{v.shiftKey||d()},f=()=>{const v=m.value.split(`
`);c.value=Math.min(v.length,5)};return L(m,()=>{f()}),(v,w)=>(i(),l("div",Ce,[n("form",{onSubmit:V(d,["prevent"]),class:"flex items-end gap-2"},[n("div",Me,[G(n("textarea",{"onUpdate:modelValue":w[0]||(w[0]=U=>m.value=U),placeholder:"Nhập tin nhắn...",class:_(["w-full border-gray-200 border rounded-2xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-none bg-gray-50",{"h-10":c.value===1,"h-20":c.value>1}]),onKeydown:ee(V(y,["prevent"]),["enter"]),onInput:f,ref_key:"textarea",ref:T},null,42,we),[[J,m.value]])]),n("button",{type:"submit",class:_(["bg-blue-500 hover:bg-blue-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-sm transition-colors",{"opacity-50 cursor-not-allowed":!b.value,"hover:shadow-md":b.value}]),disabled:!b.value},w[1]||(w[1]=[n("i",{class:"fab fa-telegram-plane"},null,-1)]),10,Se)],32)]))}},$e={class:"h-full flex bg-white shadow-md rounded-lg overflow-hidden"},Ie={class:"w-1/3 border-r border-gray-100 flex flex-col"},_e={class:"py-3 px-4 border-b border-gray-100 bg-white"},Ne={class:"relative mt-2"},De={class:"flex-1 overflow-y-auto"},Ue={key:0,class:"p-4 text-center"},Ae={key:1,class:"p-4 text-center"},Be={class:"w-2/3 flex flex-col"},He={class:"py-3 px-4 border-b border-gray-100 flex items-center justify-between bg-white shadow-sm"},je={class:"flex items-center"},Le={class:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center overflow-hidden mr-3"},Oe=["src"],Re={key:1,class:"fas fa-user text-blue-500"},Fe={class:"font-medium text-gray-800"},qe={key:0,class:"text-xs text-green-500"},We={key:1,class:"py-2 text-center mb-2"},Pe={key:2,class:"my-auto text-center"},Ve={key:3,class:"my-auto text-center py-12"},Ye={class:"flex flex-col space-y-2"},Ke={key:0,class:"py-2 text-center"},Ee={key:1,class:"flex-1 flex items-center justify-center flex-col p-4"},Je={__name:"ChatContainer",setup(r){const e=te(),S=se(),g=ne(),m=I(""),T=I(null),c=I(null),b=I(!1),d=I(!0),y=z("chatUserId",null);console.log("Giá trị userId được inject từ component cha:",y);const f=A(()=>{var s;return(s=S.userInfo)==null?void 0:s.user_id});L(()=>g.query.user,s=>{if(s){console.log("Tham số user đã thay đổi:",s);const t=parseInt(s,10);isNaN(t)||(console.log("Chọn cuộc trò chuyện mới từ URL thay đổi:",t),k(t))}},{immediate:!1});const v=A(()=>{if(!e.conversations.length)return[];const s=new Map;return e.conversations.forEach(a=>{const p=a.sender===f.value?a.recipient:a.sender,o=typeof p=="string"?parseInt(p,10):p,M=e.userInfoCache[o];let h=e.lastMessages[o];if(h){const W=typeof h.sender=="string"?parseInt(h.sender,10):h.sender,P=typeof h.recipient=="string"?parseInt(h.recipient,10):h.recipient;W===f.value&&P===o||W===o&&P===f.value||(h=null)}let O="";M&&M.fullname?O=M.fullname:h&&h.recipient_fullname&&o!==f.value?O=h.recipient_fullname:h&&h.sender_fullname?O=h.sender_fullname:O=`Người dùng #${o}`,s.has(o)||s.set(o,{userId:o,displayName:O,avatar:(M==null?void 0:M.avatar)||null,isOnline:!1,lastMessage:(h==null?void 0:h.content)||"",lastMessageTime:(h==null?void 0:h.created_at)||"",unreadCount:0})}),Array.from(s.values()).sort((a,u)=>a.lastMessageTime?u.lastMessageTime?new Date(u.lastMessageTime)-new Date(a.lastMessageTime):-1:1)}),w=A(()=>{if(!m.value)return v.value;const s=m.value.toLowerCase();return v.value.filter(t=>t.displayName.toLowerCase().includes(s))});A(()=>e.activeConversation?v.value.find(s=>s.userId===e.activeConversation):null);const U=s=>{console.log("Lấy tên hiển thị cho conversation:",s);const t=s.userId,a=e.userInfoCache[t];return a&&a.fullname?a.fullname:s.displayName||`Người dùng #${s.userId}`},k=async s=>{if(console.log("Đang chọn cuộc trò chuyện với userId:",s),e.activeConversation=s,T.value=s,e.activeConversation===s&&e.sortedMessages.length>0){console.log("Cuộc trò chuyện này đã được chọn và có tin nhắn, không tải lại");return}e.page=1,e.hasMoreMessages=!0;try{let t=!e.userInfoCache[s],a=null;t&&(a=e.fetchUserInfo(s));const u=await e.fetchMessages(s,!0);!u||u.length<20?e.hasMoreMessages=!1:e.hasMoreMessages=!0,await Promise.all([a].filter(Boolean)),await C(),await j(),setTimeout(()=>{N(),console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện")},100)}catch(t){console.error("Lỗi khi tải tin nhắn:",t)}finally{e.loading=!1}},C=async()=>{const s=e.sortedMessages.filter(t=>!t.is_read&&t.sender!==f.value);if(s.length>0){console.log(`Đánh dấu ${s.length} tin nhắn là đã đọc`);for(const t of s)try{await e.markMessageAsRead(t.id)}catch(a){console.error(`Lỗi khi đánh dấu tin nhắn ${t.id} là đã đọc:`,a)}}},F=async s=>{if(e.activeConversation)try{const t=await e.sendMessage(e.activeConversation,s);console.log("📤 Đã gửi tin nhắn mới:",t);const a=v.value.find(u=>u.userId===e.activeConversation);a&&(console.log("Cập nhật tin nhắn mới nhất cho cuộc trò chuyện hiện tại:",a.userId),a.lastMessage=s,a.lastMessageTime=new Date().toISOString()),setTimeout(async()=>{try{console.log("Tải tin nhắn mới nhất sau khi gửi tin nhắn"),await e.fetchLatestMessages(),console.log("Đã cập nhật tin nhắn mới nhất cho tất cả cuộc trò chuyện")}catch(u){console.error("Lỗi khi tải tin nhắn mới nhất sau khi gửi:",u)}},500),setTimeout(()=>{const u=e.sortedMessages[e.sortedMessages.length-1];u&&u.content===s?console.log("✅ Tin nhắn đã được thêm vào danh sách, không cần mô phỏng"):(console.log("⚠️ Không tìm thấy tin nhắn mới trong danh sách, mô phỏng tin nhắn"),t&&(e.addMessage({...t,is_read:!0}),e.sortConversationToTop(t)))},500),await j(),N()}catch(t){console.error("Lỗi khi gửi tin nhắn:",t)}},N=()=>{c.value&&(console.log("Thực hiện cuộn xuống cuối cùng"),c.value.scrollTop=c.value.scrollHeight,setTimeout(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight,console.log("Đã cuộn xuống lần thứ hai để đảm bảo hiển thị tin nhắn mới nhất"))},100))},Q=async()=>{if(!c.value||!e.activeConversation)return;const{scrollTop:s,clientHeight:t,scrollHeight:a}=c.value;if(d.value=a-s-t<100,s<=20&&!b.value&&e.hasMoreMessages){console.log("Đang tải thêm tin nhắn cũ hơn...");const u=a;b.value=!0;try{if(await e.fetchMessages(e.activeConversation),await j(),c.value){const M=c.value.scrollHeight-u+20;c.value.scrollTop=M,console.log(`Đã điều chỉnh scrollTop từ 0 đến ${M}px`)}}catch(p){console.error("Lỗi khi tải thêm tin nhắn cũ hơn:",p)}finally{setTimeout(()=>{b.value=!1},500)}}};L(()=>JSON.stringify(e.sortedMessages),()=>{if(console.log("Nội dung tin nhắn đã thay đổi (deep check)"),C(),c.value){const{scrollTop:s,scrollHeight:t,clientHeight:a}=c.value,u=t-s-a<300,p=e.sortedMessages[e.sortedMessages.length-1],o=p&&p.sender===f.value;(u||o)&&(console.log("Nội dung thay đổi và người dùng gần cuối hoặc gửi tin nhắn mới, đang cuộn xuống"),N(),j(()=>{N()}))}}),L(()=>e.sortedMessages.length,(s,t)=>{if(s>t){console.log(`Số lượng tin nhắn đã tăng từ ${t} lên ${s}`);const a=e.sortedMessages[e.sortedMessages.length-1];if(a&&c.value){const{scrollTop:u,scrollHeight:p,clientHeight:o}=c.value,M=p-u-o<300,h=a.sender===f.value;(M||h)&&(console.log("Có tin nhắn mới và người dùng gần cuối hoặc tin nhắn từ user hiện tại, cuộn xuống"),N())}}}),L(()=>e.activeConversation,(s,t)=>{s!==t&&(console.log(`Active conversation changed from ${t} to ${s}`),j(()=>{N()}))}),L(()=>e.sortedMessages,(s,t)=>{if(console.log("Tin nhắn thay đổi, danh sách cuộc trò chuyện sẽ được cập nhật"),s.length>t.length){const a=s[s.length-1];e.activeConversation===a.sender&&(console.log("Tin nhắn mới thuộc cuộc trò chuyện đang mở"),a.recipient===f.value&&!a.is_read&&e.markMessageAsRead(a.id))}},{deep:!0});const q=s=>{if(console.log("Nhận tin nhắn từ socket:",s),s&&s.type==="chat_message"){const t=s.message;if(e.addMessage(t),e.activeConversation===t.sender){e.markMessageAsRead(t.id);const a=v.value.find(u=>u.userId===t.sender);a&&(a.lastMessage=t.content,a.lastMessageTime=t.created_at,console.log("Cập nhật tin nhắn mới nhất cho cuộc trò chuyện đang mở:",a)),j(()=>{N()})}setTimeout(async()=>{try{console.log("Tải tin nhắn mới nhất sau khi nhận tin nhắn từ socket"),await e.fetchLatestMessages(),console.log("Đã cập nhật tin nhắn mới nhất cho tất cả cuộc trò chuyện")}catch(a){console.error("Lỗi khi tải tin nhắn mới nhất sau khi nhận tin nhắn socket:",a)}},500)}};ae(async()=>{console.log("ChatContainer đã được mount"),X();let s=null;g.query.user?(s=parseInt(g.query.user,10),console.log("Tìm thấy tham số user trong URL:",s)):y&&(s=y,console.log("Sử dụng userId được inject:",s));try{await Promise.all([e.fetchConversations(),e.fetchUnreadMessages()]),await e.fetchLatestMessages(),console.log("Đã tải xong dữ liệu ban đầu, số cuộc trò chuyện:",e.conversations.length),s&&!isNaN(s)&&(console.log("Thực hiện chọn cuộc trò chuyện với userId:",s),await k(s)),Z()}catch(t){console.error("Lỗi khi khởi tạo ChatContainer:",t)}$.onMessage(q)});const X=()=>{console.log("Đang khởi tạo kết nối WebSocket..."),$.init(),setTimeout(()=>{$.connected?console.log("✅ WebSocket đã kết nối thành công!"):(console.log("⚠️ WebSocket chưa kết nối sau 2 giây, thử kết nối lại..."),$.disconnect(),$.init())},2e3)};let H=null;const Z=()=>{H&&clearInterval(H),H=setInterval(()=>{$.connected?console.log("✓ WebSocket vẫn đang kết nối"):(console.log("⚠️ Phát hiện WebSocket đã ngắt kết nối, đang thử kết nối lại..."),$.init())},3e4)};return oe(()=>{console.log("ChatContainer đã được unmount"),H&&(clearInterval(H),H=null),$.disconnect(),$.offMessage(q)}),(s,t)=>{var a,u,p;return i(),l("div",$e,[n("div",Ie,[n("div",_e,[t[2]||(t[2]=n("h2",{class:"text-lg font-semibold text-gray-800"},"Tin nhắn",-1)),n("div",Ne,[G(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),placeholder:"Tìm kiếm cuộc trò chuyện...",class:"w-full border-gray-200 border rounded-xl pl-9 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-gray-50"},null,512),[[J,m.value]]),t[1]||(t[1]=n("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[n("i",{class:"fas fa-search"})],-1))])]),n("div",De,[x(e).loading&&!x(e).activeConversation?(i(),l("div",Ue,t[3]||(t[3]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải danh sách...",-1)]))):w.value.length===0?(i(),l("div",Ae,t[4]||(t[4]=[n("i",{class:"fas fa-comments text-gray-300 text-4xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Không có cuộc trò chuyện nào",-1)]))):(i(!0),l(R,{key:2},Y(w.value,o=>(i(),K(ke,{key:o.id,"display-name":U(o),avatar:o.avatar,"last-message":o.lastMessage,"last-message-time":o.lastMessageTime,"unread-count":o.unreadCount,"is-online":o.isOnline,"is-active":x(e).activeConversation===o.userId,userId:o.userId,onSelect:M=>k(o.userId)},null,8,["display-name","avatar","last-message","last-message-time","unread-count","is-online","is-active","userId","onSelect"]))),128))])]),n("div",Be,[x(e).activeConversation?(i(),l(R,{key:0},[n("div",He,[n("div",je,[n("div",Le,[(a=x(e).activeConversation)!=null&&a.avatar?(i(),l("img",{key:0,src:x(e).activeConversation.avatar,alt:"Avatar",class:"w-full h-full object-cover"},null,8,Oe)):(i(),l("i",Re))]),n("div",null,[n("h3",Fe,D((u=x(e).activeConversation)==null?void 0:u.displayName),1),(p=x(e).activeConversation)!=null&&p.isOnline?(i(),l("p",qe,t[5]||(t[5]=[n("i",{class:"fas fa-circle mr-1 text-[8px]"},null,-1),E(" Đang hoạt động ")]))):B("",!0)])])]),n("div",{class:"flex-1 p-4 overflow-y-auto flex flex-col relative bg-gray-50",ref_key:"messagesContainer",ref:c,onScroll:Q},[!d.value&&x(e).sortedMessages.length>5?(i(),l("button",{key:0,onClick:N,class:"absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 shadow-md z-10 transition-colors",title:"Cuộn xuống tin nhắn mới nhất"},t[6]||(t[6]=[n("i",{class:"fas fa-arrow-down"},null,-1)]))):B("",!0),b.value?(i(),l("div",We,t[7]||(t[7]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải thêm tin nhắn cũ hơn...",-1)]))):B("",!0),x(e).loading&&!x(e).sortedMessages.length?(i(),l("div",Pe,t[8]||(t[8]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải tin nhắn...",-1),n("p",{class:"text-xs text-gray-400 mt-1"},"Đang tải nhiều trang để hiển thị đầy đủ cuộc trò chuyện",-1)]))):x(e).sortedMessages.length?(i(),l(R,{key:4},[n("div",Ye,[(i(!0),l(R,null,Y(x(e).sortedMessages,o=>(i(),K(de,{key:o.id,content:o.content,"is-current-user":o.sender===f.value,"is-read":o.is_read,"created-at":o.created_at},null,8,["content","is-current-user","is-read","created-at"]))),128))]),x(e).loading&&x(e).sortedMessages.length?(i(),l("div",Ke,t[10]||(t[10]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải tin nhắn...",-1)]))):B("",!0)],64)):(i(),l("div",Ve,t[9]||(t[9]=[n("i",{class:"fas fa-comment-dots text-gray-300 text-5xl mb-3"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Chưa có tin nhắn. Hãy gửi tin nhắn đầu tiên!",-1)])))],544),re(Te,{loading:x(e).loading,onSendMessage:F},null,8,["loading"])],64)):(i(),l("div",Ee,t[11]||(t[11]=[n("i",{class:"fas fa-comments text-gray-300 text-6xl mb-4"},null,-1),n("h3",{class:"text-xl font-medium text-gray-700 mb-2"},"Trò chuyện của bạn",-1),n("p",{class:"text-gray-500 text-center max-w-md"}," Chọn một cuộc trò chuyện từ danh sách bên trái hoặc bắt đầu một cuộc trò chuyện mới. ",-1)])))])])}}};export{Je as _};
