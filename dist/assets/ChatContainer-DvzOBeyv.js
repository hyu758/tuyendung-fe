import{E as N,c,a as i,e as n,t as _,n as S,f as W,d as U,X as z,j as T,G as L,q as E,v as G,M as ee,x as V,U as te,i as se,B as ne,P as B,o as ae,O as M,z as oe,p as C,F as D,h as K,k as F,g as le}from"./index-CyIo3ZF1.js";const ie={class:"whitespace-pre-wrap text-[15px]"},re={key:0,class:"ml-1"},ce={key:0,class:"fas fa-check-double"},ue={key:1,class:"fas fa-check"},de={__name:"ChatMessage",props:{content:{type:String,required:!0},isCurrentUser:{type:Boolean,default:!1},isRead:{type:Boolean,default:!1},createdAt:{type:[String,Date],required:!0}},setup(l){const s=l,w=N(()=>{const p=new Date(s.createdAt);return isNaN(p.getTime())?"":p.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})});return(p,g)=>(i(),c("div",{class:S(["flex",l.isCurrentUser?"justify-end":"justify-start","mb-3"])},[n("div",{class:S(["max-w-[70%] rounded-2xl px-4 py-2.5 break-words shadow-sm",l.isCurrentUser?"bg-blue-500 text-white rounded-br-none":"bg-gray-100 text-gray-800 rounded-bl-none"])},[n("p",ie,_(l.content),1),n("div",{class:S(["text-xs mt-1 flex justify-end items-center",l.isCurrentUser?"text-blue-100":"text-gray-500"])},[W(_(w.value)+" ",1),l.isCurrentUser?(i(),c("span",re,[l.isRead?(i(),c("i",ce)):(i(),c("i",ue))])):U("",!0)],2)],2)],2))}},he={class:"flex-shrink-0 mr-3 relative"},ge={key:0,class:"w-12 h-12 rounded-full overflow-hidden shadow-sm"},fe=["src"],me={key:1,class:"w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold shadow-sm"},ye={key:2,class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"},ve={class:"flex-1 min-w-0"},xe={class:"flex justify-between items-center"},pe={class:"flex items-center mt-1"},be={key:0,class:"ml-2 bg-blue-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center shadow-sm"},ke={__name:"ChatConversation",props:{displayName:{type:String,required:!0},avatar:{type:String,default:null},lastMessage:{type:String,default:""},lastMessageTime:{type:String,default:""},unreadCount:{type:Number,default:0},isOnline:{type:Boolean,default:!1},isActive:{type:Boolean,default:!1},isRead:{type:Boolean,default:!0},userId:{type:[Number,String],required:!0},openInPopup:{type:Boolean,default:!1}},emits:["select"],setup(l,{emit:s}){const w=l,p=s,g=z("openChat",null),d=N(()=>{if(!w.lastMessageTime)return"";const v=new Date(w.lastMessageTime),m=new Date-v,h=Math.floor(m/(1e3*60));return h<1?"Vừa xong":h<60?`${h} phút`:h<24*60?`${Math.floor(h/60)}h`:h<7*24*60?`${Math.floor(h/(24*60))} ngày`:v.toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit"})}),u=v=>v?v.split(" ").filter(k=>k.length>0).map(k=>k.charAt(0).toUpperCase()).slice(0,2).join(""):"?",b=()=>{w.openInPopup&&g?g(w.userId):p("select")};return(v,k)=>(i(),c("div",{class:S(["flex items-center px-4 py-3 cursor-pointer transition-colors border-b border-gray-100",{"bg-blue-50":l.isActive,"hover:bg-gray-50":!l.isActive,"border-l-4 border-l-blue-500":l.isActive}]),onClick:b},[n("div",he,[l.avatar?(i(),c("div",ge,[n("img",{src:l.avatar,alt:"Avatar",class:"w-full h-full object-cover"},null,8,fe)])):(i(),c("div",me,_(u(l.displayName)),1)),l.isOnline?(i(),c("div",ye)):U("",!0)]),n("div",ve,[n("div",xe,[n("h3",{class:S(["text-sm font-medium truncate",[l.unreadCount>0?"text-gray-900 font-semibold":"text-gray-700"]])},_(l.displayName),3),n("span",{class:S(["text-xs text-gray-500",[l.unreadCount>0?"text-blue-600 font-semibold":"text-gray-500"]])},_(d.value),3)]),n("div",pe,[n("p",{class:S(["text-sm truncate flex-1",{"text-gray-700 font-medium":!l.isRead&&l.unreadCount>0,"text-gray-500":l.isRead||l.unreadCount===0}])},_(l.lastMessage),3),l.unreadCount>0?(i(),c("span",be,_(l.unreadCount>99?"99+":l.unreadCount),1)):U("",!0)])])],2))}},we={class:"border-t border-gray-100 py-3 px-4 bg-white"},Me={class:"relative flex-1"},Ce=["onKeydown"],Te=["disabled"],Se={__name:"ChatInput",props:{loading:{type:Boolean,default:!1}},emits:["send-message"],setup(l,{emit:s}){const w=l,p=s,g=T(""),d=T(null),u=T(1);T(!1);const b=N(()=>g.value.trim().length>0&&!w.loading),v=()=>{b.value&&(p("send-message",g.value.trim()),g.value="",u.value=1,setTimeout(()=>{d.value.focus()},10))},k=h=>{h.shiftKey||v()},m=()=>{const h=g.value.split(`
`);u.value=Math.min(h.length,5)};return L(g,()=>{m()}),(h,$)=>(i(),c("div",we,[n("form",{onSubmit:V(v,["prevent"]),class:"flex items-end gap-2"},[n("div",Me,[E(n("textarea",{"onUpdate:modelValue":$[0]||($[0]=j=>g.value=j),placeholder:"Nhập tin nhắn...",class:S(["w-full border-gray-200 border rounded-2xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-none bg-gray-50",{"h-10":u.value===1,"h-20":u.value>1}]),onKeydown:ee(V(k,["prevent"]),["enter"]),onInput:m,ref_key:"textarea",ref:d},null,42,Ce),[[G,g.value]])]),n("button",{type:"submit",class:S(["bg-blue-500 hover:bg-blue-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-sm transition-colors",{"opacity-50 cursor-not-allowed":!b.value,"hover:shadow-md":b.value}]),disabled:!b.value},$[1]||($[1]=[n("i",{class:"fab fa-telegram-plane"},null,-1)]),10,Te)],32)]))}},Ie={class:"h-full flex bg-white shadow-md rounded-lg overflow-hidden"},_e={class:"w-1/3 border-r border-gray-100 flex flex-col"},$e={class:"py-3 px-4 border-b border-gray-100 bg-white"},Ne={class:"relative mt-2"},Ue={class:"flex-1 overflow-y-auto"},je={key:0,class:"p-4 text-center"},Ae={key:1,class:"p-4 text-center"},Be={class:"w-2/3 flex flex-col"},Le={class:"py-3 px-4 border-b border-gray-100 flex items-center justify-between bg-white shadow-sm"},De={class:"flex items-center"},He={class:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center overflow-hidden mr-3"},Re=["src"],qe={key:1,class:"fas fa-user text-blue-500"},Oe={class:"font-medium text-gray-800"},Pe={key:0,class:"text-xs text-green-500"},Ve={key:1,class:"py-2 text-center mb-2"},Ke={key:2,class:"my-auto text-center"},Fe={key:3,class:"my-auto text-center py-12"},We={class:"flex flex-col space-y-2"},ze={key:0,class:"py-2 text-center"},Ee={key:1,class:"flex-1 flex items-center justify-center flex-col p-4"},Qe={__name:"ChatContainer",setup(l){const s=te(),w=se(),p=ne(),g=T(""),d=T(null),u=T(null),b=T(!1),v=T(!0),k=z("chatUserId",null);console.log("Giá trị userId được inject từ component cha:",k);const m=N(()=>{var t;return(t=w.userInfo)==null?void 0:t.user_id});L(()=>p.query.user,t=>{if(t){console.log("Tham số user đã thay đổi:",t);const e=parseInt(t,10);isNaN(e)||(console.log("Chọn cuộc trò chuyện mới từ URL thay đổi:",e),H(e))}},{immediate:!1});const h=N(()=>{if(!s.conversations.length)return[];const t=new Map;return s.conversations.forEach(a=>{const y=a.sender===m.value?a.recipient:a.sender,o=typeof y=="string"?parseInt(y,10):y,x=s.userInfoCache[o];let f=s.lastMessages[o];if(f){const O=typeof f.sender=="string"?parseInt(f.sender,10):f.sender,P=typeof f.recipient=="string"?parseInt(f.recipient,10):f.recipient;O===m.value&&P===o||O===o&&P===m.value||(f=null)}t.has(o)||t.set(o,{userId:o,displayName:(x==null?void 0:x.fullname)||`Người dùng #${o}`,avatar:(x==null?void 0:x.avatar)||null,isOnline:!1,lastMessage:(f==null?void 0:f.content)||"",lastMessageTime:(f==null?void 0:f.created_at)||"",unreadCount:0})}),Array.from(t.values()).sort((a,r)=>a.lastMessageTime?r.lastMessageTime?new Date(r.lastMessageTime)-new Date(a.lastMessageTime):-1:1)}),$=N(()=>{if(!g.value)return h.value;const t=g.value.toLowerCase();return h.value.filter(e=>e.displayName.toLowerCase().includes(t))}),j=N(()=>d.value?h.value.find(t=>t.userId===d.value):null),J=t=>(console.log("Lấy tên hiển thị cho conversation:",t),t.displayName||`Người dùng #${t.userId}`),H=async t=>{if(console.log("Đang chọn cuộc trò chuyện với userId:",t),d.value===t&&s.messages.length>0){console.log("Cuộc trò chuyện này đã được chọn và có tin nhắn, không tải lại");return}d.value=t,s.messages=[],s.page=1,s.hasMoreMessages=!0,s.loading=!0;try{let e=!s.userInfoCache[t],a=null;e&&(a=s.fetchUserInfo(t));const r=await s.fetchMessages(t,!0);!r||r.length<20?s.hasMoreMessages=!1:s.hasMoreMessages=!0,await Promise.all([a].filter(Boolean)),await R(),await B(),setTimeout(()=>{I(),console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện")},100)}catch(e){console.error("Lỗi khi tải tin nhắn:",e)}finally{s.loading=!1}},R=async()=>{const t=s.messages.filter(e=>!e.is_read&&e.sender!==m.value);if(t.length>0){console.log(`Đánh dấu ${t.length} tin nhắn là đã đọc`);for(const e of t)try{await s.markMessageAsRead(e.id)}catch(a){console.error(`Lỗi khi đánh dấu tin nhắn ${e.id} là đã đọc:`,a)}}},Q=async t=>{if(d.value)try{const e=await s.sendMessage(d.value,t);console.log("📤 Đã gửi tin nhắn mới:",e);const a=h.value.find(r=>r.userId===d.value);a&&(console.log("Cập nhật tin nhắn mới nhất cho cuộc trò chuyện hiện tại:",a.userId),a.lastMessage=t,a.lastMessageTime=new Date().toISOString()),setTimeout(async()=>{try{console.log("Tải tin nhắn mới nhất sau khi gửi tin nhắn"),await s.fetchLatestMessages(),console.log("Đã cập nhật tin nhắn mới nhất cho tất cả cuộc trò chuyện")}catch(r){console.error("Lỗi khi tải tin nhắn mới nhất sau khi gửi:",r)}},500),setTimeout(()=>{const r=s.sortedMessages[s.sortedMessages.length-1];r&&r.content===t?console.log("✅ Tin nhắn đã được thêm vào danh sách, không cần mô phỏng"):(console.log("⚠️ Không tìm thấy tin nhắn mới trong danh sách, mô phỏng tin nhắn"),e&&(s.addMessage({...e,is_read:!0}),s.sortConversationToTop(e)))},500),await B(),I()}catch(e){console.error("Lỗi khi gửi tin nhắn:",e)}},I=()=>{u.value&&(console.log("Thực hiện cuộn xuống cuối cùng"),u.value.scrollTop=u.value.scrollHeight,setTimeout(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight,console.log("Đã cuộn xuống lần thứ hai để đảm bảo hiển thị tin nhắn mới nhất"))},100))},X=async()=>{if(!u.value||!d.value)return;const{scrollTop:t,clientHeight:e,scrollHeight:a}=u.value;if(v.value=a-t-e<100,t<=20&&!b.value&&s.hasMoreMessages){console.log("Đang tải thêm tin nhắn cũ hơn...");const r=a;b.value=!0;try{if(await s.fetchMessages(d.value),await B(),u.value){const x=u.value.scrollHeight-r+20;u.value.scrollTop=x,console.log(`Đã điều chỉnh scrollTop từ 0 đến ${x}px`)}}catch(y){console.error("Lỗi khi tải thêm tin nhắn cũ hơn:",y)}finally{setTimeout(()=>{b.value=!1},500)}}};L(()=>JSON.stringify(s.sortedMessages),()=>{if(console.log("Nội dung tin nhắn đã thay đổi (deep check)"),R(),u.value){const{scrollTop:t,scrollHeight:e,clientHeight:a}=u.value,r=e-t-a<300,y=s.sortedMessages[s.sortedMessages.length-1],o=y&&y.sender===m.value;(r||o)&&(console.log("Nội dung thay đổi và người dùng gần cuối hoặc gửi tin nhắn mới, đang cuộn xuống"),I(),B(()=>{I()}))}}),L(()=>s.sortedMessages.length,(t,e)=>{if(t>e){console.log(`Số lượng tin nhắn đã tăng từ ${e} lên ${t}`);const a=s.sortedMessages[s.sortedMessages.length-1];if(a&&u.value){const{scrollTop:r,scrollHeight:y,clientHeight:o}=u.value,x=y-r-o<300,f=a.sender===m.value;(x||f)&&(console.log("Có tin nhắn mới và người dùng gần cuối hoặc tin nhắn từ user hiện tại, cuộn xuống"),I())}}}),L(()=>s.activeConversation,(t,e)=>{t!==e&&(console.log(`Active conversation changed from ${e} to ${t}`),B(()=>{I()}))}),L(()=>s.messages,(t,e)=>{if(console.log("Tin nhắn thay đổi, danh sách cuộc trò chuyện sẽ được cập nhật"),t.length>e.length){const a=s.sortedMessages[s.sortedMessages.length-1];if(a){const r=a.sender===m.value?a.recipient:a.sender;d.value===r&&(console.log("Tin nhắn mới thuộc cuộc trò chuyện đang mở"),a.recipient===m.value&&!a.is_read&&s.markMessageAsRead(a.id))}}},{deep:!0});const q=t=>{if(console.log("Nhận tin nhắn từ socket:",t),t&&t.type==="chat_message"){const e=t.message;if(s.addMessage(e),d.value===e.sender){s.markMessageAsRead(e.id);const a=h.value.find(r=>r.userId===e.sender);a&&(a.lastMessage=e.content,a.lastMessageTime=e.created_at,console.log("Cập nhật tin nhắn mới nhất cho cuộc trò chuyện đang mở:",a)),B(()=>{I()})}setTimeout(async()=>{try{console.log("Tải tin nhắn mới nhất sau khi nhận tin nhắn từ socket"),await s.fetchLatestMessages(),console.log("Đã cập nhật tin nhắn mới nhất cho tất cả cuộc trò chuyện")}catch(a){console.error("Lỗi khi tải tin nhắn mới nhất sau khi nhận tin nhắn socket:",a)}},500)}};ae(async()=>{console.log("ChatContainer đã được mount"),Y();let t=null;p.query.user?(t=parseInt(p.query.user,10),console.log("Tìm thấy tham số user trong URL:",t)):k&&(t=k,console.log("Sử dụng userId được inject:",t));try{await Promise.all([s.fetchConversations(),s.fetchUnreadMessages()]),await s.fetchLatestMessages(),console.log("Đã tải xong dữ liệu ban đầu, số cuộc trò chuyện:",s.conversations.length),t&&!isNaN(t)&&(console.log("Thực hiện chọn cuộc trò chuyện với userId:",t),await H(t)),Z()}catch(e){console.error("Lỗi khi khởi tạo ChatContainer:",e)}M.onMessage(q)});const Y=()=>{console.log("Đang khởi tạo kết nối WebSocket..."),M.init(),setTimeout(()=>{M.connected?console.log("✅ WebSocket đã kết nối thành công!"):(console.log("⚠️ WebSocket chưa kết nối sau 2 giây, thử kết nối lại..."),M.disconnect(),M.init())},2e3)};let A=null;const Z=()=>{A&&clearInterval(A),A=setInterval(()=>{M.connected?console.log("✓ WebSocket vẫn đang kết nối"):(console.log("⚠️ Phát hiện WebSocket đã ngắt kết nối, đang thử kết nối lại..."),M.init())},3e4)};return oe(()=>{console.log("ChatContainer đã được unmount"),A&&(clearInterval(A),A=null),M.disconnect(),M.offMessage(q)}),(t,e)=>{var a,r,y;return i(),c("div",Ie,[n("div",_e,[n("div",$e,[e[2]||(e[2]=n("h2",{class:"text-lg font-semibold text-gray-800"},"Tin nhắn",-1)),n("div",Ne,[E(n("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>g.value=o),placeholder:"Tìm kiếm cuộc trò chuyện...",class:"w-full border-gray-200 border rounded-xl pl-9 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent bg-gray-50"},null,512),[[G,g.value]]),e[1]||(e[1]=n("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[n("i",{class:"fas fa-search"})],-1))])]),n("div",Ue,[C(s).loading&&!d.value?(i(),c("div",je,e[3]||(e[3]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải danh sách...",-1)]))):$.value.length===0?(i(),c("div",Ae,e[4]||(e[4]=[n("i",{class:"fas fa-comments text-gray-300 text-4xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Không có cuộc trò chuyện nào",-1)]))):(i(!0),c(D,{key:2},K($.value,o=>(i(),F(ke,{key:o.id,"display-name":J(o),avatar:o.avatar,"last-message":o.lastMessage,"last-message-time":o.lastMessageTime,"unread-count":o.unreadCount,"is-online":o.isOnline,"is-active":d.value===o.userId,userId:o.userId,onSelect:x=>H(o.userId)},null,8,["display-name","avatar","last-message","last-message-time","unread-count","is-online","is-active","userId","onSelect"]))),128))])]),n("div",Be,[d.value?(i(),c(D,{key:0},[n("div",Le,[n("div",De,[n("div",He,[(a=j.value)!=null&&a.avatar?(i(),c("img",{key:0,src:j.value.avatar,alt:"Avatar",class:"w-full h-full object-cover"},null,8,Re)):(i(),c("i",qe))]),n("div",null,[n("h3",Oe,_((r=j.value)==null?void 0:r.displayName),1),(y=j.value)!=null&&y.isOnline?(i(),c("p",Pe,e[5]||(e[5]=[n("i",{class:"fas fa-circle mr-1 text-[8px]"},null,-1),W(" Đang hoạt động ")]))):U("",!0)])])]),n("div",{class:"flex-1 p-4 overflow-y-auto flex flex-col relative bg-gray-50",ref_key:"messagesContainer",ref:u,onScroll:X},[!v.value&&C(s).messages.length>5?(i(),c("button",{key:0,onClick:I,class:"absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 shadow-md z-10 transition-colors",title:"Cuộn xuống tin nhắn mới nhất"},e[6]||(e[6]=[n("i",{class:"fas fa-arrow-down"},null,-1)]))):U("",!0),b.value?(i(),c("div",Ve,e[7]||(e[7]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải thêm tin nhắn cũ hơn...",-1)]))):U("",!0),C(s).loading&&!C(s).messages.length?(i(),c("div",Ke,e[8]||(e[8]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500 text-xl"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Đang tải tin nhắn...",-1),n("p",{class:"text-xs text-gray-400 mt-1"},"Đang tải nhiều trang để hiển thị đầy đủ cuộc trò chuyện",-1)]))):C(s).messages.length?(i(),c(D,{key:4},[n("div",We,[(i(!0),c(D,null,K(C(s).sortedMessages,o=>(i(),F(de,{key:o.id,content:o.content,"is-current-user":o.sender===m.value,"is-read":o.is_read,"created-at":o.created_at},null,8,["content","is-current-user","is-read","created-at"]))),128))]),C(s).loading&&C(s).messages.length?(i(),c("div",ze,e[10]||(e[10]=[n("i",{class:"fas fa-circle-notch fa-spin text-blue-500"},null,-1),n("p",{class:"text-xs text-gray-500"},"Đang tải tin nhắn...",-1)]))):U("",!0)],64)):(i(),c("div",Fe,e[9]||(e[9]=[n("i",{class:"fas fa-comment-dots text-gray-300 text-5xl mb-3"},null,-1),n("p",{class:"mt-2 text-gray-500"},"Chưa có tin nhắn. Hãy gửi tin nhắn đầu tiên!",-1)])))],544),le(Se,{loading:C(s).loading,onSendMessage:Q},null,8,["loading"])],64)):(i(),c("div",Ee,e[11]||(e[11]=[n("i",{class:"fas fa-comments text-gray-300 text-6xl mb-4"},null,-1),n("h3",{class:"text-xl font-medium text-gray-700 mb-2"},"Trò chuyện của bạn",-1),n("p",{class:"text-gray-500 text-center max-w-md"}," Chọn một cuộc trò chuyện từ danh sách bên trái hoặc bắt đầu một cuộc trò chuyện mới. ",-1)])))])])}}};export{Qe as _};
